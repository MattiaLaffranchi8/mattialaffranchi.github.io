<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostore Cyber: Multiplayer Client</title>
    <meta name="description" content="Client multiplayer per il Gioco dell'Impostore. Si connette al server Socket.IO.">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        /* Variabili Globali e Tema Cyber Dark */
        :root {
            --colore-sfondo-profondo: #0a0a1a;
            --colore-pannello: #1c1c3a;
            --colore-accento-impostore: #ff3366; /* Neon Rosso */
            --colore-accento-cittadino: #33ccff; /* Neon Blu */
            --colore-testo: #e0e0ff;
            --colore-bordo: #555588;
            --colore-ombra: rgba(0, 0, 0, 0.7);
            --font-principale: 'Orbitron', 'Arial', sans-serif;
            --spaziatura: 25px;
            --raggio-bordo: 10px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-principale);
            background-color: var(--colore-sfondo-profondo);
            color: var(--colore-testo);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spaziatura);
        }

        /* Contenitore Principale (Console di Gioco) */
        #app-container {
            width: 100%;
            max-width: 900px;
            background-color: var(--colore-pannello);
            border-radius: var(--raggio-bordo);
            border: 1px solid var(--colore-bordo);
            box-shadow: 0 0 40px var(--colore-ombra);
            padding: var(--spaziatura);
            transition: all 0.5s ease-in-out;
        }

        .schermo {
            display: none;
            padding: var(--spaziatura) 0;
            text-align: center;
        }

        .schermo.attivo {
            display: block;
        }

        h1 {
            color: var(--colore-accento-impostore);
            margin-bottom: var(--spaziatura);
            font-size: 2.5em;
            text-shadow: 0 0 10px var(--colore-accento-impostore);
        }

        h2 {
            color: var(--colore-accento-cittadino);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8em;
            text-shadow: 0 0 5px rgba(51, 204, 255, 0.5);
        }
        
        /* Layout per i pulsanti di Lobby */
        .lobby-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        /* Elementi di Input e Pulsanti */
        select, input[type="text"], input[type="number"], button {
            padding: 12px 20px;
            border-radius: var(--raggio-bordo);
            border: 2px solid var(--colore-bordo);
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--colore-testo);
            background-color: #2a2a4c;
            font-family: var(--font-principale);
            transition: all 0.3s ease-in-out;
            text-transform: uppercase;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        /* Stile Pulsante Principale */
        button {
            cursor: pointer;
            background: linear-gradient(90deg, #444477, #666699);
            border-color: var(--colore-bordo);
            box-shadow: 0 0 8px rgba(102, 102, 153, 0.5);
            font-weight: bold;
            letter-spacing: 1px;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(90deg, #666699, #8888bb);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 102, 153, 0.7);
        }

        button:disabled {
            background-color: #3a3a5c;
            border-color: #2a2a4c;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        /* Gruppi di Configurazione/Lobby */
        .config-gruppo {
            margin-bottom: var(--spaziatura);
            padding: 15px;
            background-color: #14142a;
            border-radius: var(--raggio-bordo);
        }

        /* OVERLAY DI RIVELAZIONE RUOLO (Forte effetto Glitch/Offuscamento) */
        #overlay-ruoli {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spaziatura);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #overlay-ruoli.attivo {
            display: flex;
            opacity: 1;
        }
        
        #contenuto-ruolo {
            max-width: 90%;
            width: 450px;
            background-color: #000000;
            border: 3px solid var(--colore-accento-impostore);
            padding: 40px 30px;
            border-radius: var(--raggio-bordo);
            box-shadow: 0 0 30px var(--colore-accento-impostore);
            animation: consoleScan 0.5s ease-out;
            text-align: center;
        }
        
        @keyframes consoleScan {
            from { transform: scale(0.9) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        #ruolo-titolo {
            font-size: 3em;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .role-impostore {
            color: var(--colore-accento-impostore);
            text-shadow: 0 0 15px var(--colore-accento-impostore);
        }

        .role-cittadino {
            color: var(--colore-accento-cittadino);
            text-shadow: 0 0 15px var(--colore-accento-cittadino);
        }

        #parola-rivelata {
            font-size: 2em;
            font-weight: bold;
            padding: 10px;
            border: 1px dashed var(--colore-testo);
            display: inline-block;
            margin: 15px 0;
        }
        
        /* Schermo Gioco (Discussione) */
        #parola-gioco {
            font-size: 3.5em;
            color: var(--colore-accento-cittadino);
            text-shadow: 0 0 15px var(--colore-accento-cittadino);
            margin: 25px 0 35px;
            animation: pulseText 1.5s infinite alternate;
        }

        @keyframes pulseText {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        #timer-gioco {
            font-size: 4em;
            color: var(--colore-accento-impostore);
            font-weight: bold;
            margin-bottom: 30px;
            padding: 10px 20px;
            border: 4px solid var(--colore-accento-impostore);
            border-radius: var(--raggio-bordo);
            display: inline-block;
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.5);
        }
        
        /* Schermo Lobby */
        #lista-giocatori-lobby {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        #lista-giocatori-lobby li {
            font-size: 1.1em;
            padding: 8px;
            border-bottom: 1px dotted var(--colore-bordo);
        }

        /* Schermo Fine Gioco */
        #schermo-fine-gioco h2 {
            font-size: 3.5em;
            margin-bottom: var(--spaziatura);
        }

        .ruolo-impostore {
            color: var(--colore-accento-impostore);
            font-weight: bold;
        }

        .ruolo-cittadino {
            color: var(--colore-accento-cittadino);
        }
        
        /* Toast Messages */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background-color: #3a3a5c;
            color: var(--colore-testo);
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
            transform: translateX(100%);
            border-left: 5px solid var(--colore-accento-cittadino);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Media query per la responsività */
        @media (max-width: 600px) {
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            #timer-gioco { font-size: 3em; }
            .lobby-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <div id="schermo-lobby" class="schermo attivo">
            <h1>:: ACCESSO RETE GIOCO ::</h1>
            <p style="margin-bottom: 15px; color: #aaa;">Connesso a: <span id="server-status">localhost:3000</span></p>

            <div class="config-gruppo">
                <h2>IDENTITÀ</h2>
                <input type="text" id="input-nome-giocatore" placeholder="Inserisci il tuo Nickname" maxlength="20" aria-label="Nome giocatore">
            </div>
            
            <div class="lobby-buttons">
                <button id="btn-crea-stanza" style="background: var(--colore-accento-cittadino); box-shadow: 0 0 10px var(--colore-accento-cittadino);" aria-label="Crea una nuova stanza di gioco">CREA NUOVA STANZA</button>
                <button id="btn-unisciti-stanza" aria-label="Unisciti a una stanza esistente">UNISCITI A STANZA</button>
            </div>
        </div>

        <div id="schermo-config-attesa" class="schermo">
            <h2>STANZA: <span id="codice-stanza-display">----</span></h2>
            
            <p id="stato-giocatore-lobby" style="margin-bottom: 20px;">[ Seleziona l'opzione qui sotto ]</p>

            <div id="config-host-section" class="config-gruppo" style="display: none;">
                <h3>[ 01 ] Parametri Partita (HOST)</h3>
                <label for="num-impostori-host">Numero Impostori:</label>
                <select id="num-impostori-host" aria-label="Seleziona il numero di impostori"></select>
                <p>Giocatori Connessi: <span id="num-giocatori-connessi">0</span> / 10</p>
                <button id="btn-inizia-gioco-host" disabled aria-label="Avvia la partita con i parametri scelti">AVVIA PROTOCOLLO GIOCO</button>
            </div>

            <div class="config-gruppo">
                <h3>[ 02 ] Identità Crew Connesse</h3>
                <ul id="lista-giocatori-lobby" role="list">
                    <li>In attesa di altri giocatori...</li>
                </ul>
            </div>
        </div>

        <div id="schermo-rivelazione" class="schermo">
            <h2>TRASMISSIONE RUOLO CRIPTATA</h2>
            <p style="margin-bottom: 30px;">Decriptazione dati in corso...</p>
            <button id="btn-mostra-ruolo-personale" style="background: var(--colore-accento-cittadino); box-shadow: 0 0 15px var(--colore-accento-cittadino);" aria-label="Mostra il tuo ruolo segreto">MOSTRA RUOLO PERSONALE</button>
        </div>

        <div id="schermo-gioco" class="schermo">
            <h2>FASE DI COMUNICAZIONE</h2>
            <p style="font-size: 1.1em; color: #aaa;">Parola di riferimento:</p>
            <p id="parola-gioco" aria-live="polite">IN ATTESA...</p>
            
            <p style="margin-bottom: 10px;">Stato del timer:</p>
            <div id="timer-gioco" role="timer" aria-live="polite">05:00</div>
            
            <p style="font-style: italic; color: #999;">Cittadini: Votate per l'Impostore. Impostore: Rimanete nascosti.</p>
            <button id="btn-vota" style="margin-top: 30px;" aria-label="Avvia la votazione per l'impostore">RICHIESTA VOTAZIONE</button>
        </div>

        <div id="schermo-fine-gioco" class="schermo">
            <h2 id="risultato-finale" style="font-size: 3em;"></h2>
            <h3>RISULTATI IDENTITÀ FINALI:</h3>
            <ul id="lista-risultati" role="list"></ul>
            <button id="btn-nuova-partita" style="margin-top: 30px;" aria-label="Torna alla lobby per una nuova partita">NUOVA PARTITA</button>
        </div>

    </div>

    <div id="modal-codice-stanza" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1500; align-items: center; justify-content: center;">
        <div style="background: var(--colore-pannello); padding: 30px; border-radius: var(--raggio-bordo); border: 2px solid var(--colore-accento-cittadino); box-shadow: 0 0 20px var(--colore-accento-cittadino);">
            <h3>INSERISCI CODICE STANZA</h3>
            <input type="text" id="input-codice-stanza" placeholder="XXXX" maxlength="4" style="margin: 15px 0;">
            <button id="btn-conferma-codice">CONFERMA</button>
            <button id="btn-annulla-codice" style="background: none; border-color: var(--colore-accento-impostore);">ANNULLA</button>
        </div>
    </div>

    <div id="overlay-ruoli" class="overlay" aria-hidden="true" style="display: none; opacity: 0;">
        <div id="contenuto-ruolo">
            <div id="dettagli-ruolo" style="margin-top: 20px;">
                <h3 id="ruolo-titolo"></h3>
                <p id="ruolo-messaggio" style="font-size: 1.1em; margin-bottom: 5px;"></p>
                <p id="parola-rivelata"></p>
                <button id="btn-chiudi-rivelazione" style="margin-top: 20px; background: var(--colore-accento-cittadino);">ACCETTA E PREPARATI</button>
            </div>
        </div>
    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        // --- CONFIGURAZIONE E STATO GLOBALE ---

        /** @typedef {Object} Giocatore */

        const gameState = {
            // Stato locale del giocatore che sta utilizzando questo browser
            myId: null, 
            myName: '',
            myRole: null,
            isHost: false,
            
            // Stato della Stanza (Sincronizzato dal server)
            roomCode: null,
            players: [], // Array di Giocatore
            parolaSegreta: null,
            timer: 300, 
            
            // UI State
            statoCorrente: 'lobby', 
        };

        // Indirizzo del server Socket.IO. Deve corrispondere all'indirizzo in cui Node.js è in esecuzione.
        // Se esegui Node.js sulla stessa macchina:
        const WS_SERVER_URL = "http://localhost:3000"; 
        
        // Se pubblicherai il gioco:
        // const WS_SERVER_URL = "https://IL_TUO_DOMINIO.com"; 

        let ws = null; // Oggetto Socket.IO

        // --- Riferimenti DOM ---
        const schermate = {
            lobby: document.getElementById('schermo-lobby'),
            configAttesa: document.getElementById('schermo-config-attesa'),
            rivelazione: document.getElementById('schermo-rivelazione'),
            gioco: document.getElementById('schermo-gioco'),
            fine: document.getElementById('schermo-fine-gioco'),
        };

        const lobbyElementi = {
            inputNome: document.getElementById('input-nome-giocatore'),
            btnCrea: document.getElementById('btn-crea-stanza'),
            btnUnisciti: document.getElementById('btn-unisciti-stanza'),
            modalCodice: document.getElementById('modal-codice-stanza'),
            inputCodice: document.getElementById('input-codice-stanza'),
            btnConfermaCodice: document.getElementById('btn-conferma-codice'),
            btnAnnullaCodice: document.getElementById('btn-annulla-codice'),
        };
        
        const configElementi = {
            codiceDisplay: document.getElementById('codice-stanza-display'),
            statoGiocatore: document.getElementById('stato-giocatore-lobby'),
            hostSection: document.getElementById('config-host-section'),
            numImpostoriHost: document.getElementById('num-impostori-host'),
            numGiocatoriConnessi: document.getElementById('num-giocatori-connessi'),
            btnInizia: document.getElementById('btn-inizia-gioco-host'),
            listaGiocatori: document.getElementById('lista-giocatori-lobby'),
        };

        const rivelazioneElementi = {
            btnMostraRuolo: document.getElementById('btn-mostra-ruolo-personale'),
            overlayRuoli: document.getElementById('overlay-ruoli'),
            ruoloTitolo: document.getElementById('ruolo-titolo'),
            ruoloMessaggio: document.getElementById('ruolo-messaggio'),
            parolaRivelata: document.getElementById('parola-rivelata'),
            btnChiudiRivelazione: document.getElementById('btn-chiudi-rivelazione'),
        };
        
        const giocoElementi = {
            parolaGioco: document.getElementById('parola-gioco'),
            timerGioco: document.getElementById('timer-gioco'),
            btnVota: document.getElementById('btn-vota'),
        };

        const fineElementi = {
            risultatoFinale: document.getElementById('risultato-finale'),
            listaRisultati: document.getElementById('lista-risultati'),
            btnNuovaPartita: document.getElementById('btn-nuova-partita'),
        };

        // --- Funzioni Utility ---
        
        function switchScreen(nextScreenId) {
            Object.values(schermate).forEach(screen => screen.classList.remove('attivo'));
            schermate[nextScreenId].classList.add('attivo');
            gameState.statoCorrente = nextScreenId;
            rivelazioneElementi.overlayRuoli.classList.remove('attivo');
            rivelazioneElementi.overlayRuoli.style.display = 'none';
            window.scrollTo(0, 0); 
        }
        
        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function varToCss(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(`--${varName}`).trim();
        }

        /** Aggiorna la visualizzazione del timer. */
        function updateTimerDisplay() {
            const minuti = Math.floor(gameState.timer / 60);
            const secondi = gameState.timer % 60;
            const displayMinuti = String(minuti).padStart(2, '0');
            const displaySecondi = String(secondi).padStart(2, '0');
            giocoElementi.timerGioco.textContent = `${displayMinuti}:${displaySecondi}`;
        }
        
        // --- LOGICA DI CONNESSIONE SOCKET.IO ---

        /** Inizializza la connessione Socket.IO. */
        function initializeWebSocket() {
            // Usa Socket.IO, con opzione per tentare la riconnessione automatica
            ws = io(WS_SERVER_URL, { reconnection: true, reconnectionAttempts: 5 });
            
            ws.on('connect', () => {
                gameState.myId = ws.id;
                showToast("Connessione SERVER stabilita.");
                // Se era in uno stato di lobby, prova a recuperare lo stato (opzionale)
            });

            ws.on('disconnect', () => {
                showToast("Connessione interrotta. Ritorno alla lobby.");
                resetGame();
            });

            ws.on('connect_error', (error) => {
                console.error("[WS] Errore di connessione Socket.IO:", error);
                showToast("ERRORE: Impossibile connettersi. Server offline o URL errato.");
            });
            
            // --- GESTIONE MESSAGGI DAL SERVER ---
            
            ws.on('ROOM_CREATED', handleRoomCreated);
            ws.on('JOINED_ROOM', handleJoinedRoom);
            ws.on('PLAYER_UPDATE', handlePlayerUpdate);
            ws.on('GAME_START', handleGameStart);
            ws.on('SYNC_TIMER', handleSyncTimer);
            ws.on('PHASE_CHANGE', handlePhaseChange);
            ws.on('GAME_ENDED', handleGameEnded);
            ws.on('ERROR', handleServerError);
        }

        /** Invia un messaggio tramite Socket.IO. */
        function sendToServer(type, data = {}) {
            if (ws && ws.connected) {
                ws.emit(type, data); 
            } else {
                showToast("Errore di rete. Riprova la connessione.");
            }
        }
        
        // --- HANDLER DI MESSAGGI (DAL SERVER) ---
        
        function handleServerError(message) {
            showToast(`ERRORE SERVER: ${message.message}`);
            // Se l'errore è grave (es. codice non valido), torna alla lobby
            if (gameState.statoCorrente !== 'lobby') {
                 resetGame();
            }
        }
        
        function handleRoomCreated(data) {
            gameState.roomCode = data.roomCode;
            gameState.myId = data.playerId;
            gameState.isHost = true;
            updateLobbyState(data.players, "Sei l'HOST! Configura e avvia.");
            setupHostControls(data.players.length);
            switchScreen('configAttesa');
            showToast(`Stanza creata! Codice: ${data.roomCode}`);
        }

        function handleJoinedRoom(data) {
            gameState.roomCode = data.roomCode;
            gameState.myId = data.playerId;
            gameState.isHost = false;
            updateLobbyState(data.players, "Sei connesso. Attendi l'Host per iniziare.");
            setupHostControls(data.players.length); // Nasconderà l'interfaccia host
            switchScreen('configAttesa');
            showToast(`Unito alla stanza ${data.roomCode}.`);
        }

        function handlePlayerUpdate(data) {
            updateLobbyState(data.players, gameState.isHost ? "Configura e avvia." : "Attendi l'Host.");
            if (gameState.isHost) {
                setupHostControls(data.players.length);
            }
        }
        
        function handleGameStart(data) {
            // Ricevuto il ruolo e la parola segreta
            gameState.parolaSegreta = data.word;
            gameState.myRole = data.role;
            gameState.players = data.players; // Lista finale dei giocatori con ruoli non rivelati
            
            // Passa alla fase di rivelazione
            startRoleRevealPhase(); 
        }
        
        function handleSyncTimer(data) {
            gameState.timer = data.timeRemaining;
            updateTimerDisplay();
        }
        
        function handlePhaseChange(data) {
            if (data.phase === 'REVEAL') {
                // Già gestito da GAME_START, ma utile per la sincronizzazione
            } else if (data.phase === 'DISCUSSION') {
                startDiscussionPhase();
                showToast("Fase di discussione iniziata! Il tempo scorre...");
            }
        }
        
        function handleGameEnded(data) {
            // Il server ha stabilito la fine del gioco
            revealFinalResults(data.winningTeam, data.finalRoles);
        }

        // --- LOGICA DI LOBBY (Client-side) ---

        function handleCreateRoom() {
            gameState.myName = lobbyElementi.inputNome.value.trim();
            if (!gameState.myName) {
                return showToast("Inserisci un nome valido.");
            }
            sendToServer('CREATE_ROOM', { playerName: gameState.myName });
            showToast("Richiesta di creazione stanza inviata...");
        }

        function handleJoinRoomRequest() {
            gameState.myName = lobbyElementi.inputNome.value.trim();
            if (!gameState.myName) {
                return showToast("Inserisci un nome valido.");
            }
            lobbyElementi.modalCodice.style.display = 'flex';
        }

        function handleConfirmCode() {
            const code = lobbyElementi.inputCodice.value.trim().toUpperCase();
            if (code.length !== 4) {
                return showToast("Il codice deve essere di 4 caratteri.");
            }

            sendToServer('JOIN_ROOM', { playerName: gameState.myName, roomCode: code });
            
            lobbyElementi.modalCodice.style.display = 'none';
            showToast(`Tentativo di unione alla stanza ${code}...`);
        }
        
        function handleCancelCode() {
            lobbyElementi.modalCodice.style.display = 'none';
            lobbyElementi.inputCodice.value = ''; 
        }
        
        /** Aggiorna la lista dei giocatori e le info sulla stanza. */
        function updateLobbyState(players, statusMessage) {
            gameState.players = players;
            configElementi.codiceDisplay.textContent = gameState.roomCode || '----';
            configElementi.statoGiocatore.textContent = statusMessage;
            configElementi.numGiocatoriConnessi.textContent = `${players.length}`;

            // Popola la lista
            configElementi.listaGiocatori.innerHTML = '';
            if (players.length === 0) {
                configElementi.listaGiocatori.innerHTML = '<li>Nessun giocatore connesso...</li>';
                return;
            }
            
            players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p.nome;
                if (p.id === gameState.myId) {
                    li.textContent += ' (TU)';
                    li.style.color = varToCss('--colore-accento-cittadino');
                } else if (p.isHost) {
                    li.textContent += ' (HOST)';
                    li.style.color = varToCss('--colore-accento-impostore');
                }
                configElementi.listaGiocatori.appendChild(li);
            });
        }
        
        /** Configura la UI per l'Host. */
        function setupHostControls(numPlayers) {
            if (!gameState.isHost) {
                configElementi.hostSection.style.display = 'none';
                return;
            }

            configElementi.hostSection.style.display = 'block';

            // Aggiorna il selettore degli Impostori
            configElementi.numImpostoriHost.innerHTML = '';
            const maxImpostori = Math.floor(numPlayers / 2);
            for (let i = 1; i <= maxImpostori; i++) {
                configElementi.numImpostoriHost.options.add(new Option(i, i));
            }
            
            // Valida il pulsante Inizia
            const canStart = numPlayers >= 3;
            configElementi.btnInizia.disabled = !canStart;
            configElementi.btnInizia.textContent = canStart ? "AVVIA PROTOCOLLO GIOCO" : "MIN. 3 GIOCATORI RICHIESTI";

            if (canStart) {
                configElementi.btnInizia.onclick = handleHostStartGame;
            }
        }

        /** L'Host invia al server il comando di iniziare il gioco. */
        function handleHostStartGame() {
            const numImpostori = parseInt(configElementi.numImpostoriHost.value, 10);
            if (isNaN(numImpostori) || numImpostori < 1) {
                return showToast("Seleziona un numero valido di Impostori.");
            }

            sendToServer('START_GAME', {
                roomCode: gameState.roomCode,
                numImpostori: numImpostori
            });
            showToast("Invio del comando di avvio al server...");
        }

        // --- FASE DI RIVELAZIONE RUOLO ---
        
        function startRoleRevealPhase() {
            switchScreen('rivelazione');
            rivelazioneElementi.btnMostraRuolo.onclick = showPersonalRole;
        }
        
        function showPersonalRole() {
            rivelazioneElementi.btnMostraRuolo.style.display = 'none';
            rivelazioneElementi.overlayRuoli.style.display = 'flex';
            
            // Animazione Glitch/Reveal
            setTimeout(() => {
                rivelazioneElementi.overlayRuoli.classList.add('attivo');
                revealRoleContent();
            }, 100); 

            rivelazioneElementi.btnChiudiRivelazione.onclick = handleRoleAcceptance;
        }
        
        function revealRoleContent() {
            // Reset classi
            rivelazioneElementi.ruoloTitolo.classList.remove('role-cittadino', 'role-impostore');
            rivelazioneElementi.parolaRivelata.style.color = varToCss('--colore-testo');

            if (gameState.myRole === 'Cittadino') {
                rivelazioneElementi.ruoloTitolo.textContent = 'STATUS: CITTADINO';
                rivelazioneElementi.ruoloTitolo.classList.add('role-cittadino');
                rivelazioneElementi.ruoloMessaggio.textContent = `Identità verificata. Chiave d'accesso:`;
                rivelazioneElementi.parolaRivelata.textContent = gameState.parolaSegreta;
                rivelazioneElementi.parolaRivelata.style.color = varToCss('--colore-accento-cittadino');
            } else { 
                rivelazioneElementi.ruoloTitolo.textContent = 'STATUS: IMPOSTORE';
                rivelazioneElementi.ruoloTitolo.classList.add('role-impostore');
                rivelazioneElementi.ruoloMessaggio.textContent = 'ATTENZIONE: Accesso negato. Nascondi la tua identità.';
                rivelazioneElementi.parolaRivelata.textContent = '[ DATI CRIPTATI ]';
                rivelazioneElementi.parolaRivelata.style.color = varToCss('--colore-accento-impostore');
            }
        }
        
        function handleRoleAcceptance() {
            rivelazioneElementi.overlayRuoli.classList.remove('attivo');
            // Nota: In un gioco reale invieresti ROLE_ACCEPTED al server, ma per semplicità
            // ci affidiamo al timer globale del server per passare alla fase DISCUSSION.
            showToast("Ruolo memorizzato. In attesa della discussione...");
        }

        // --- FASE DI GIOCO (Discussione Sincronizzata) ---
        
        function startDiscussionPhase() {
            switchScreen('gioco');
            
            // Solo i cittadini vedono la parola reale, l'impostore vede un messaggio criptato
            giocoElementi.parolaGioco.textContent = (gameState.myRole === 'Cittadino') 
                ? gameState.parolaSegreta 
                : 'PAROLA NON RILEVATA'; 
            
            giocoElementi.btnVota.onclick = handleStartVoting;
        }
        
        /** Avvia la votazione (richiesta al server). */
        function handleStartVoting() {
            sendToServer('REQUEST_VOTE', {
                roomCode: gameState.roomCode,
                playerId: gameState.myId
            });
            showToast("Richiesta votazione inviata al server.");
        }

        // --- FASE DI FINE GIOCO ---

        /** Ritorna alla fase di fine gioco e rivela tutti i ruoli. */
        function revealFinalResults(winningTeam, finalRoles) {
            switchScreen('fine');

            finalRoles = finalRoles || gameState.players.map(p => ({ nome: p.nome, ruolo: p.ruolo }));

            fineElementi.risultatoFinale.textContent = `${winningTeam.toUpperCase()} VITTORIOSI!`;
            fineElementi.risultatoFinale.style.color = (winningTeam === 'Cittadini') 
                ? varToCss('--colore-accento-cittadino') 
                : varToCss('--colore-accento-impostore');
            
            fineElementi.listaRisultati.innerHTML = '';
            finalRoles.forEach(g => {
                const li = document.createElement('li');
                const ruoloClass = g.ruolo === 'Impostore' ? 'ruolo-impostore' : 'ruolo-cittadino';
                li.innerHTML = `<strong>${g.nome}</strong>: <span class="${ruoloClass}">${g.ruolo.toUpperCase()}</span>`;
                fineElementi.listaRisultati.appendChild(li);
            });
            
            fineElementi.btnNuovaPartita.onclick = resetGame;
        }

        /** Resetta lo stato del gioco e torna alla schermata iniziale (lobby). */
        function resetGame() {
            // Pulisce lo stato locale
            gameState.myRole = null;
            gameState.isHost = false;
            gameState.roomCode = null;
            gameState.players = [];
            gameState.parolaSegreta = null;
            gameState.timer = 300;

            // Riconnette al server se la connessione è stata persa
            if (!ws || !ws.connected) {
                initializeWebSocket();
            }
            
            // Pulisci l'interfaccia e torna alla lobby
            switchScreen('lobby');
        }

        // --- Inizializzazione ---
        
        function init() {
            // 1. Inizializza i listener per la lobby
            lobbyElementi.btnCrea.onclick = handleCreateRoom;
            lobbyElementi.btnUnisciti.onclick = handleJoinRoomRequest;
            lobbyElementi.btnConfermaCodice.onclick = handleConfirmCode;
            lobbyElementi.btnAnnullaCodice.onclick = handleCancelCode;

            // 2. Inizializza la connessione Socket.IO
            initializeWebSocket(); 
            
            // Pre-compila il nome per accelerare i test
            lobbyElementi.inputNome.value = "Giocatore_" + Math.floor(Math.random() * 999);
            
            console.log("Applicazione Gioco dell'Impostore (Multiplayer Client) avviata.");
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
