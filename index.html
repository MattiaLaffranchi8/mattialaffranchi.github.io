<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostore Cyber: Multiplayer Client</title>
    <meta name="description" content="Client multiplayer per il Gioco dell'Impostore, con grafica dark-mode e Vanilla JS. Richiede un server backend (WebSocket) per il funzionamento completo.">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Variabili Globali e Tema Cyber Dark */
        :root {
            --colore-sfondo-profondo: #0a0a1a;
            --colore-pannello: #1c1c3a;
            --colore-accento-impostore: #ff3366; /* Neon Rosso */
            --colore-accento-cittadino: #33ccff; /* Neon Blu */
            --colore-testo: #e0e0ff;
            --colore-bordo: #555588;
            --colore-ombra: rgba(0, 0, 0, 0.7);
            --font-principale: 'Orbitron', 'Arial', sans-serif;
            --spaziatura: 25px;
            --raggio-bordo: 10px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-principale);
            background-color: var(--colore-sfondo-profondo);
            color: var(--colore-testo);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spaziatura);
        }

        /* Contenitore Principale (Console di Gioco) */
        #app-container {
            width: 100%;
            max-width: 900px;
            background-color: var(--colore-pannello);
            border-radius: var(--raggio-bordo);
            border: 1px solid var(--colore-bordo);
            box-shadow: 0 0 40px var(--colore-ombra);
            padding: var(--spaziatura);
            transition: all 0.5s ease-in-out;
        }

        .schermo {
            display: none;
            padding: var(--spaziatura) 0;
            text-align: center;
        }

        .schermo.attivo {
            display: block;
        }

        h1 {
            color: var(--colore-accento-impostore);
            margin-bottom: var(--spaziatura);
            font-size: 2.5em;
            text-shadow: 0 0 10px var(--colore-accento-impostore);
        }

        h2 {
            color: var(--colore-accento-cittadino);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8em;
            text-shadow: 0 0 5px rgba(51, 204, 255, 0.5);
        }
        
        /* Layout per i pulsanti di Lobby */
        .lobby-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        /* Elementi di Input e Pulsanti */
        select, input[type="text"], input[type="number"], button {
            padding: 12px 20px;
            border-radius: var(--raggio-bordo);
            border: 2px solid var(--colore-bordo);
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--colore-testo);
            background-color: #2a2a4c;
            font-family: var(--font-principale);
            transition: all 0.3s ease-in-out;
            text-transform: uppercase;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        /* Stile Pulsante Principale */
        button {
            cursor: pointer;
            background: linear-gradient(90deg, #444477, #666699);
            border-color: var(--colore-bordo);
            box-shadow: 0 0 8px rgba(102, 102, 153, 0.5);
            font-weight: bold;
            letter-spacing: 1px;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(90deg, #666699, #8888bb);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 102, 153, 0.7);
        }

        button:disabled {
            background-color: #3a3a5c;
            border-color: #2a2a4c;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        /* Gruppi di Configurazione/Lobby */
        .config-gruppo {
            margin-bottom: var(--spaziatura);
            padding: 15px;
            background-color: #14142a;
            border-radius: var(--raggio-bordo);
        }

        /* OVERLAY DI RIVELAZIONE RUOLO (Forte effetto Glitch/Offuscamento) */
        #overlay-ruoli {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spaziatura);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #overlay-ruoli.attivo {
            display: flex;
            opacity: 1;
        }
        
        #contenuto-ruolo {
            max-width: 90%;
            width: 450px;
            background-color: #000000;
            border: 3px solid var(--colore-accento-impostore);
            padding: 40px 30px;
            border-radius: var(--raggio-bordo);
            box-shadow: 0 0 30px var(--colore-accento-impostore);
            animation: consoleScan 0.5s ease-out;
            text-align: center;
        }
        
        @keyframes consoleScan {
            from { transform: scale(0.9) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        #ruolo-titolo {
            font-size: 3em;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .role-impostore {
            color: var(--colore-accento-impostore);
            text-shadow: 0 0 15px var(--colore-accento-impostore);
        }

        .role-cittadino {
            color: var(--colore-accento-cittadino);
            text-shadow: 0 0 15px var(--colore-accento-cittadino);
        }

        #parola-rivelata {
            font-size: 2em;
            font-weight: bold;
            padding: 10px;
            border: 1px dashed var(--colore-testo);
            display: inline-block;
            margin: 15px 0;
        }
        
        /* Schermo Gioco (Discussione) */
        #parola-gioco {
            font-size: 3.5em;
            color: var(--colore-accento-cittadino);
            text-shadow: 0 0 15px var(--colore-accento-cittadino);
            margin: 25px 0 35px;
            animation: pulseText 1.5s infinite alternate;
        }

        @keyframes pulseText {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        #timer-gioco {
            font-size: 4em;
            color: var(--colore-accento-impostore);
            font-weight: bold;
            margin-bottom: 30px;
            padding: 10px 20px;
            border: 4px solid var(--colore-accento-impostore);
            border-radius: var(--raggio-bordo);
            display: inline-block;
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.5);
        }
        
        /* Schermo Lobby */
        #lista-giocatori-lobby {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        #lista-giocatori-lobby li {
            font-size: 1.1em;
            padding: 8px;
            border-bottom: 1px dotted var(--colore-bordo);
        }

        /* Schermo Fine Gioco */
        #schermo-fine-gioco h2 {
            font-size: 3.5em;
            margin-bottom: var(--spaziatura);
        }

        .ruolo-impostore {
            color: var(--colore-accento-impostore);
            font-weight: bold;
        }

        .ruolo-cittadino {
            color: var(--colore-accento-cittadino);
        }
        
        /* Toast Messages */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background-color: #3a3a5c;
            color: var(--colore-testo);
            border-left: 5px solid var(--colore-accento-cittadino);
        }
        
        /* Media query per la responsività */
        @media (max-width: 600px) {
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            #timer-gioco { font-size: 3em; }
            .lobby-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <div id="schermo-lobby" class="schermo attivo">
            <h1>:: ACCESSO RETE GIOCO ::</h1>

            <div class="config-gruppo">
                <h2>IDENTITÀ</h2>
                <input type="text" id="input-nome-giocatore" placeholder="Inserisci il tuo Nickname" maxlength="20" aria-label="Nome giocatore">
            </div>
            
            <div class="lobby-buttons">
                <button id="btn-crea-stanza" style="background: var(--colore-accento-cittadino); box-shadow: 0 0 10px var(--colore-accento-cittadino);" aria-label="Crea una nuova stanza di gioco">CREA NUOVA STANZA</button>
                <button id="btn-unisciti-stanza" aria-label="Unisciti a una stanza esistente">UNISCITI A STANZA</button>
            </div>
        </div>

        <div id="schermo-config-attesa" class="schermo">
            <h2>STANZA: <span id="codice-stanza-display">----</span></h2>
            
            <p id="stato-giocatore-lobby" style="margin-bottom: 20px;">[ Seleziona l'opzione qui sotto ]</p>

            <div id="config-host-section" class="config-gruppo" style="display: none;">
                <h3>[ 01 ] Parametri Partita (HOST)</h3>
                <label for="num-impostori-host">Numero Impostori:</label>
                <select id="num-impostori-host" aria-label="Seleziona il numero di impostori"></select>
                <p>Giocatori Connessi: <span id="num-giocatori-connessi">0</span> / 10</p>
                <button id="btn-inizia-gioco-host" disabled aria-label="Avvia la partita con i parametri scelti">AVVIA PROTOCOLLO GIOCO</button>
            </div>

            <div class="config-gruppo">
                <h3>[ 02 ] Identità Crew Connesse</h3>
                <ul id="lista-giocatori-lobby" role="list">
                    <li>In attesa di altri giocatori...</li>
                </ul>
            </div>
        </div>

        <div id="schermo-rivelazione" class="schermo">
            <h2>TRASMISSIONE RUOLO CRIPTATA</h2>
            <p style="margin-bottom: 30px;">Decriptazione dati in corso...</p>
            <button id="btn-mostra-ruolo-personale" style="background: var(--colore-accento-cittadino); box-shadow: 0 0 15px var(--colore-accento-cittadino);" aria-label="Mostra il tuo ruolo segreto">MOSTRA RUOLO PERSONALE</button>
        </div>

        <div id="schermo-gioco" class="schermo">
            <h2>FASE DI COMUNICAZIONE</h2>
            <p style="font-size: 1.1em; color: #aaa;">Parola di riferimento:</p>
            <p id="parola-gioco" aria-live="polite">PAROLA</p>
            
            <p style="margin-bottom: 10px;">Stato del timer:</p>
            <div id="timer-gioco" role="timer" aria-live="polite">05:00</div>
            
            <p style="font-style: italic; color: #999;">Cittadini: Votate per l'Impostore. Impostore: Rimanete nascosti.</p>
            <button id="btn-vota" style="margin-top: 30px;" aria-label="Avvia la votazione per l'impostore">AVVIA VOTAZIONE (Simulata)</button>
        </div>

        <div id="schermo-fine-gioco" class="schermo">
            <h2 id="risultato-finale" style="font-size: 3em;"></h2>
            <h3>RISULTATI IDENTITÀ FINALI:</h3>
            <ul id="lista-risultati" role="list"></ul>
            <button id="btn-nuova-partita" style="margin-top: 30px;" aria-label="Torna alla lobby per una nuova partita">NUOVA PARTITA</button>
        </div>

    </div>

    <div id="modal-codice-stanza" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1500; align-items: center; justify-content: center;">
        <div style="background: var(--colore-pannello); padding: 30px; border-radius: var(--raggio-bordo); border: 2px solid var(--colore-accento-cittadino); box-shadow: 0 0 20px var(--colore-accento-cittadino);">
            <h3>INSERISCI CODICE STANZA</h3>
            <input type="text" id="input-codice-stanza" placeholder="XXXX" maxlength="4" style="margin: 15px 0;">
            <button id="btn-conferma-codice">CONFERMA</button>
            <button id="btn-annulla-codice" style="background: none; border-color: var(--colore-accento-impostore);">ANNULLA</button>
        </div>
    </div>

    <div id="overlay-ruoli" aria-hidden="true" style="display: none;">
        <div id="contenuto-ruolo">
            <div id="dettagli-ruolo" style="margin-top: 20px;">
                <h3 id="ruolo-titolo"></h3>
                <p id="ruolo-messaggio" style="font-size: 1.1em; margin-bottom: 5px;"></p>
                <p id="parola-rivelata"></p>
                <button id="btn-chiudi-rivelazione" style="margin-top: 20px; background: var(--colore-accento-cittadino);">ACCETTA E PREPARATI</button>
            </div>
        </div>
    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        // --- CONFIGURAZIONE E STATO GLOBALE ---

        /**
         * @typedef {Object} Giocatore
         * @property {string} id - ID univoco (assegnato dal server).
         * @property {string} nome - Nome scelto dal giocatore.
         * @property {string} ruolo - 'Cittadino' o 'Impostore' (assegnato dal server).
         * @property {boolean} isHost - Vero se è l'host della stanza.
         */

        const gameState = {
            // Stato locale del giocatore che sta utilizzando questo browser
            myId: null, 
            myName: '',
            myRole: null,
            isHost: false,
            
            // Stato della Stanza (Sincronizzato dal server)
            roomCode: null,
            players: [], // Array di Giocatore
            parolaSegreta: '',
            timer: 300, 
            intervalloTimer: null,
            
            // UI State
            statoCorrente: 'lobby', 
        };

        // Indirizzo del server WebSocket (PLACEHOLDER)
        const WS_SERVER_URL = "ws://localhost:8080"; 
        let ws = null; // Oggetto WebSocket

        const parole = [
            'casa', 'cane', 'albero', 'fiore', 'libro', 'tavolo', 'sedia', 'sole', 'luna', 'stella',
            'acqua', 'aria', 'terra', 'fuoco', 'pioggia', 'neve', 'gatto', 'topo', 'uccello', 'pesce',
            'pane', 'latte', 'zucchero', 'sale', 'frutta', 'verdura', 'scuola', 'lavoro', 'strada', 'città',
            'montagna', 'mare', 'fiume', 'ponte', 'auto', 'treno', 'aereo', 'nave', 'orologio', 'telefono',
            'gioco', 'musica', 'film', 'sport', 'amico', 'famiglia', 'tempo', 'denaro', 'carta', 'penna'
        ];

        // --- Riferimenti DOM ---
        const schermate = {
            lobby: document.getElementById('schermo-lobby'),
            configAttesa: document.getElementById('schermo-config-attesa'),
            rivelazione: document.getElementById('schermo-rivelazione'),
            gioco: document.getElementById('schermo-gioco'),
            fine: document.getElementById('schermo-fine-gioco'),
        };

        const lobbyElementi = {
            inputNome: document.getElementById('input-nome-giocatore'),
            btnCrea: document.getElementById('btn-crea-stanza'),
            btnUnisciti: document.getElementById('btn-unisciti-stanza'),
            modalCodice: document.getElementById('modal-codice-stanza'),
            inputCodice: document.getElementById('input-codice-stanza'),
            btnConfermaCodice: document.getElementById('btn-conferma-codice'),
            btnAnnullaCodice: document.getElementById('btn-annulla-codice'),
        };
        
        const configElementi = {
            codiceDisplay: document.getElementById('codice-stanza-display'),
            statoGiocatore: document.getElementById('stato-giocatore-lobby'),
            hostSection: document.getElementById('config-host-section'),
            numImpostoriHost: document.getElementById('num-impostori-host'),
            numGiocatoriConnessi: document.getElementById('num-giocatori-connessi'),
            btnInizia: document.getElementById('btn-inizia-gioco-host'),
            listaGiocatori: document.getElementById('lista-giocatori-lobby'),
        };

        const rivelazioneElementi = {
            btnMostraRuolo: document.getElementById('btn-mostra-ruolo-personale'),
            overlayRuoli: document.getElementById('overlay-ruoli'),
            ruoloTitolo: document.getElementById('ruolo-titolo'),
            ruoloMessaggio: document.getElementById('ruolo-messaggio'),
            parolaRivelata: document.getElementById('parola-rivelata'),
            btnChiudiRivelazione: document.getElementById('btn-chiudi-rivelazione'),
        };
        
        const giocoElementi = {
            parolaGioco: document.getElementById('parola-gioco'),
            timerGioco: document.getElementById('timer-gioco'),
            btnVota: document.getElementById('btn-vota'), // Simula il voto
        };

        const fineElementi = {
            risultatoFinale: document.getElementById('risultato-finale'),
            listaRisultati: document.getElementById('lista-risultati'),
            btnNuovaPartita: document.getElementById('btn-nuova-partita'),
        };

        // --- Funzioni Utility (Non dipendono dal server) ---
        
        function switchScreen(nextScreenId) {
            Object.values(schermate).forEach(screen => screen.classList.remove('attivo'));
            schermate[nextScreenId].classList.add('attivo');
            gameState.statoCorrente = nextScreenId;
            rivelazioneElementi.overlayRuoli.style.display = 'none';
            window.scrollTo(0, 0); 
        }
        
        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function varToCss(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(`--${varName}`).trim();
        }

        // --- LOGICA DI CONNESSIONE (SCHEMATICA) ---

        /**
         * Inizializza la connessione WebSocket.
         * NECESSITA DI UN SERVER ESTERNO PER FUNZIONARE.
         */
        function initializeWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) return;

            try {
                ws = new WebSocket(WS_SERVER_URL);
                
                ws.onopen = () => {
                    console.log("[WS] Connesso al server.");
                    showToast("Connessione stabilita. Pronto per la lobby.");
                };

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleServerMessage(message);
                };

                ws.onerror = (error) => {
                    console.error("[WS] Errore di connessione:", error);
                    showToast("ERRORE: Impossibile connettersi al server (backend offline).");
                    // Qui gestiresti un fallback o un reset
                };

                ws.onclose = () => {
                    console.log("[WS] Connessione chiusa.");
                    showToast("Connessione persa. Ritorno alla lobby.");
                    resetGame(); // Torna allo stato iniziale
                };
                
            } catch (e) {
                // Questo catch gestisce l'errore se l'URL non è valido o se la connessione fallisce prima di onopen/onerror
                showToast("IMPOSSIBILE AVVIARE LA CONNESSIONE. Verifica che il server sia attivo.");
                console.error("Errore critico di connessione WebSocket:", e);
            }
        }

        /**
         * Invia un messaggio JSON al server.
         * @param {Object} data - Dati da inviare.
         */
        function sendToServer(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            } else {
                console.warn("Impossibile inviare: connessione WebSocket non pronta.", data);
                showToast("Errore di rete. Riprova la connessione.");
            }
        }
        
        /**
         * Gestisce i messaggi ricevuti dal server.
         * @param {Object} message - Messaggio dal server, con campo 'type'.
         */
        function handleServerMessage(message) {
            console.log("[WS] Messaggio ricevuto:", message.type, message);

            switch (message.type) {
                case 'ROOM_CREATED':
                    gameState.myId = message.playerId;
                    gameState.roomCode = message.roomCode;
                    gameState.isHost = true;
                    updateLobbyState(message.players, "Sei l'HOST! Configura e avvia.");
                    setupHostControls(message.numPlayers);
                    switchScreen('configAttesa');
                    break;
                case 'JOINED_ROOM':
                    gameState.myId = message.playerId;
                    gameState.roomCode = message.roomCode;
                    gameState.isHost = false;
                    updateLobbyState(message.players, "Sei connesso. Attendi l'Host per iniziare.");
                    switchScreen('configAttesa');
                    break;
                case 'PLAYER_UPDATE':
                    // Aggiorna la lista giocatori quando qualcuno si unisce/lascia
                    updateLobbyState(message.players, gameState.isHost ? "Configura e avvia." : "Attendi l'Host.");
                    // L'host deve convalidare il pulsante di inizio
                    if (gameState.isHost) {
                        setupHostControls(message.players.length);
                    }
                    break;
                case 'GAME_START':
                    // Il gioco è iniziato, il server invia il ruolo e la parola a TUTTI
                    gameState.parolaSegreta = message.word.toUpperCase();
                    gameState.myRole = message.role;
                    gameState.players = message.players; // Lista completa e finale dei giocatori

                    // Rivelazione del ruolo individuale (passa allo schermo 3)
                    startRoleRevealPhase(); 
                    break;
                case 'SYNC_TIMER':
                    // Sincronizzazione del timer
                    gameState.timer = message.timeRemaining;
                    updateTimerDisplay();
                    break;
                case 'PHASE_CHANGE':
                    // Passaggio automatico alla fase di discussione
                    if (message.phase === 'DISCUSSION') {
                        startDiscussionPhase();
                    }
                    // Aggiungere logica per 'VOTATION', 'END_GAME' ecc.
                    break;
                case 'GAME_ENDED':
                    // Il server decide quando il gioco finisce e invia il risultato
                    revealFinalResults(message.winningTeam, message.finalRoles);
                    break;
                case 'ERROR':
                    showToast(`ERRORE SERVER: ${message.message}`);
                    break;
                default:
                    console.warn("Messaggio server sconosciuto:", message);
            }
        }
        
        // --- LOGICA DI LOBBY ---

        function handleCreateRoom() {
            gameState.myName = lobbyElementi.inputNome.value.trim();
            if (!gameState.myName) {
                showToast("Inserisci un nome valido.");
                return;
            }
            
            // Invia la richiesta di creazione stanza al server
            sendToServer({
                type: 'CREATE_ROOM',
                playerName: gameState.myName
            });
            showToast("Richiesta di creazione stanza inviata...");
        }

        function handleJoinRoomRequest() {
            gameState.myName = lobbyElementi.inputNome.value.trim();
            if (!gameState.myName) {
                showToast("Inserisci un nome valido.");
                return;
            }
            // Mostra il modale per inserire il codice
            lobbyElementi.modalCodice.style.display = 'flex';
        }

        function handleConfirmCode() {
            const code = lobbyElementi.inputCodice.value.trim().toUpperCase();
            if (code.length !== 4) {
                showToast("Il codice deve essere di 4 caratteri.");
                return;
            }

            // Invia la richiesta di unione al server
            sendToServer({
                type: 'JOIN_ROOM',
                playerName: gameState.myName,
                roomCode: code
            });
            
            lobbyElementi.modalCodice.style.display = 'none';
            showToast(`Tentativo di unione alla stanza ${code}...`);
        }
        
        function handleCancelCode() {
            lobbyElementi.modalCodice.style.display = 'none';
            lobbyElementi.inputCodice.value = ''; // Pulisce il campo
        }
        
        /**
         * Aggiorna la lista dei giocatori e le info sulla stanza.
         * @param {Array<Giocatore>} players - Lista dei giocatori connessi.
         * @param {string} statusMessage - Messaggio di stato.
         */
        function updateLobbyState(players, statusMessage) {
            gameState.players = players;
            configElementi.codiceDisplay.textContent = gameState.roomCode || '----';
            configElementi.statoGiocatore.textContent = statusMessage;
            configElementi.numGiocatoriConnessi.textContent = `${players.length}`;

            // Popola la lista
            configElementi.listaGiocatori.innerHTML = '';
            if (players.length === 0) {
                configElementi.listaGiocatori.innerHTML = '<li>Nessun giocatore connesso...</li>';
                return;
            }
            
            players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p.nome;
                if (p.id === gameState.myId) {
                    li.textContent += ' (TU)';
                    li.style.color = varToCss('--colore-accento-cittadino');
                } else if (p.isHost) {
                    li.textContent += ' (HOST)';
                    li.style.color = varToCss('--colore-accento-impostore');
                }
                configElementi.listaGiocatori.appendChild(li);
            });
        }
        
        /**
         * Configura la UI per l'Host.
         * @param {number} numPlayers - Numero di giocatori attuali.
         */
        function setupHostControls(numPlayers) {
            if (!gameState.isHost) {
                configElementi.hostSection.style.display = 'none';
                return;
            }

            configElementi.hostSection.style.display = 'block';

            // Aggiorna il selettore degli Impostori
            configElementi.numImpostoriHost.innerHTML = '';
            const maxImpostori = Math.floor(numPlayers / 2);
            for (let i = 1; i <= maxImpostori; i++) {
                configElementi.numImpostoriHost.options.add(new Option(i, i));
            }
            
            // Valida il pulsante Inizia
            const canStart = numPlayers >= 3;
            configElementi.btnInizia.disabled = !canStart;
            configElementi.btnInizia.textContent = canStart ? "AVVIA PROTOCOLLO GIOCO" : "MIN. 3 GIOCATORI RICHIESTI";

            if (canStart && !configElementi.btnInizia.dataset.listenerAdded) {
                configElementi.btnInizia.addEventListener('click', handleHostStartGame);
                configElementi.btnInizia.dataset.listenerAdded = true;
            }
        }

        /**
         * L'Host invia al server il comando di iniziare il gioco.
         */
        function handleHostStartGame() {
            const numImpostori = parseInt(configElementi.numImpostoriHost.value, 10);
            if (isNaN(numImpostori) || numImpostori < 1) {
                showToast("Seleziona un numero valido di Impostori.");
                return;
            }

            sendToServer({
                type: 'START_GAME',
                roomCode: gameState.roomCode,
                numImpostori: numImpostori
            });
            showToast("Invio del comando di avvio al server...");
        }

        // --- FASE DI RIVELAZIONE RUOLO (Multiplayer) ---
        
        /**
         * Gestisce la fase in cui il server ha inviato il ruolo.
         */
        function startRoleRevealPhase() {
            switchScreen('rivelazione');
            // Il ruolo è in gameState.myRole e la parola in gameState.parolaSegreta
            rivelazioneElementi.btnMostraRuolo.addEventListener('click', showPersonalRole, { once: true });
        }
        
        /**
         * Mostra il ruolo solo al giocatore che preme il pulsante.
         */
        function showPersonalRole() {
            rivelazioneElementi.btnMostraRuolo.style.display = 'none';
            rivelazioneElementi.overlayRuoli.style.display = 'flex';
            rivelazioneElementi.overlayRuoli.classList.add('attivo');

            // Reset classi
            rivelazioneElementi.ruoloTitolo.classList.remove('role-cittadino', 'role-impostore');
            rivelazioneElementi.parolaRivelata.style.color = varToCss('--colore-testo');

            if (gameState.myRole === 'Cittadino') {
                rivelazioneElementi.ruoloTitolo.textContent = 'STATUS: CITTADINO';
                rivelazioneElementi.ruoloTitolo.classList.add('role-cittadino');
                rivelazioneElementi.ruoloMessaggio.textContent = `Identità verificata. Chiave d'accesso:`;
                rivelazioneElementi.parolaRivelata.textContent = gameState.parolaSegreta;
                rivelazioneElementi.parolaRivelata.style.color = varToCss('--colore-accento-cittadino');
            } else { 
                rivelazioneElementi.ruoloTitolo.textContent = 'STATUS: IMPOSTORE';
                rivelazioneElementi.ruoloTitolo.classList.add('role-impostore');
                rivelazioneElementi.ruoloMessaggio.textContent = 'ATTENZIONE: Accesso negato. Nascondi la tua identità.';
                rivelazioneElementi.parolaRivelata.textContent = '[ DATI CRIPTATI ]';
                rivelazioneElementi.parolaRivelata.style.color = varToCss('--colore-accento-impostore');
            }
            
            rivelazioneElementi.btnChiudiRivelazione.addEventListener('click', handleRoleAcceptance, { once: true });
        }
        
        /**
         * Il giocatore conferma di aver visto il proprio ruolo.
         */
        function handleRoleAcceptance() {
            rivelazioneElementi.overlayRuoli.classList.remove('attivo');
            // Invia notifica al server (simulato)
            // sendToServer({ type: 'ROLE_ACCEPTED', playerId: gameState.myId, roomCode: gameState.roomCode }); 
            showToast("Ruolo accettato. Preparati per la discussione...");
            
            // In un gioco reale, si aspetterebbe il messaggio PHAS_CHANGE dal server
            // che viene inviato solo quando TUTTI i giocatori hanno accettato.
        }

        // --- FASE DI GIOCO (Discussione Sincronizzata) ---
        
        function startDiscussionPhase() {
            switchScreen('gioco');
            
            // La parola è già stata impostata da GAME_START
            giocoElementi.parolaGioco.textContent = (gameState.myRole === 'Cittadino') 
                ? gameState.parolaSegreta 
                : 'PAROLA NON RILEVATA'; // Solo i cittadini vedono la parola, l'impostore vede un placeholder
            
            // Il timer è gestito e sincronizzato dal server (messaggio SYNC_TIMER)
            // L'interfaccia si limita a visualizzare i dati ricevuti

            giocoElementi.btnVota.addEventListener('click', handleStartVoting, { once: true });
        }
        
        /**
         * Aggiorna la visualizzazione del timer (in base ai dati del server).
         */
        function updateTimerDisplay() {
            const minuti = Math.floor(gameState.timer / 60);
            const secondi = gameState.timer % 60;
            const displayMinuti = String(minuti).padStart(2, '0');
            const displaySecondi = String(secondi).padStart(2, '0');
            giocoElementi.timerGioco.textContent = `${displayMinuti}:${displaySecondi}`;
            
            // Questo codice non ha bisogno di un intervallo locale se il server invia SYNC_TIMER ogni secondo.
        }

        /**
         * Avvia la votazione (richiesta al server).
         */
        function handleStartVoting() {
            // Invia la richiesta di votazione. Solo l'host o un voto unanime avvia la votazione.
            sendToServer({
                type: 'REQUEST_VOTE',
                roomCode: gameState.roomCode,
                playerId: gameState.myId
            });
            showToast("Richiesta votazione inviata. In attesa del server...");
            
            // In un gioco reale, il server passerebbe a uno schermo di votazione
            // switchScreen('votazione'); 
        }

        // --- FASE DI FINE GIOCO ---

        /**
         * Ritorna alla fase di fine gioco e rivela tutti i ruoli.
         * @param {string} winningTeam - Il team vincente ('Cittadini' o 'Impostori').
         * @param {Array<Object>} finalRoles - Lista completa dei ruoli dal server.
         */
        function revealFinalResults(winningTeam, finalRoles) {
            switchScreen('fine');

            finalRoles = finalRoles || gameState.players.map(p => ({ nome: p.nome, ruolo: p.ruolo }));

            fineElementi.risultatoFinale.textContent = `${winningTeam.toUpperCase()} VITTORIOSI!`;
            fineElementi.risultatoFinale.style.color = (winningTeam === 'Cittadini') 
                ? varToCss('--colore-accento-cittadino') 
                : varToCss('--colore-accento-impostore');
            
            fineElementi.listaRisultati.innerHTML = '';
            finalRoles.forEach(g => {
                const li = document.createElement('li');
                const ruoloClass = g.ruolo === 'Impostore' ? 'ruolo-impostore' : 'ruolo-cittadino';
                li.innerHTML = `<strong>${g.nome}</strong>: <span class="${ruoloClass}">${g.ruolo.toUpperCase()}</span>`;
                fineElementi.listaRisultati.appendChild(li);
            });
            
            fineElementi.btnNuovaPartita.addEventListener('click', resetGame);
        }

        /**
         * Resetta lo stato del gioco e torna alla schermata iniziale (lobby).
         */
        function resetGame() {
            // Pulisce lo stato locale e i listener
            gameState.myId = null;
            gameState.myRole = null;
            gameState.isHost = false;
            gameState.roomCode = null;
            gameState.players = [];
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                // Notifica il server che stiamo uscendo dalla stanza (simulato)
                // ws.send(JSON.stringify({ type: 'LEAVE_ROOM', playerId: gameState.myId }));
            }
            
            // Rimuovi vecchi listener (solo quelli che non sono once)
            configElementi.btnInizia.removeEventListener('click', handleHostStartGame); 
            configElementi.btnInizia.dataset.listenerAdded = false;

            // Pulisci l'interfaccia
            lobbyElementi.inputNome.value = gameState.myName; 
            switchScreen('lobby');
        }

        // --- Inizializzazione ---
        
        function init() {
            // 1. Inizializza i listener per la lobby
            lobbyElementi.btnCrea.addEventListener('click', handleCreateRoom);
            lobbyElementi.btnUnisciti.addEventListener('click', handleJoinRoomRequest);
            lobbyElementi.btnConfermaCodice.addEventListener('click', handleConfirmCode);
            lobbyElementi.btnAnnullaCodice.addEventListener('click', handleCancelCode);

            // 2. Inizializza la connessione WebSocket (Necessaria per la logica multiplayer)
            initializeWebSocket(); 
            
            // Inserimento simulato del nome (per testare la creazione/join)
            lobbyElementi.inputNome.value = "Giocatore" + Math.floor(Math.random() * 100);
            
            console.log("Applicazione Gioco dell'Impostore (Multiplayer Client) avviata.");
            showToast("Connessione in corso...");
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
